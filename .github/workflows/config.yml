name: Jut-suTests

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Choose type of the tests'
        required: true
        default: 'positive'
        type: choice
        options:
          - positive
          - negative
          - all

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Setup Python
        uses: actions/setup-python@v3
        with:
          python-version: "3.11"
      - name: Install Chrome
        run: sudo apt-get install google-chrome-stable
      - name: Install dependencies
        run: pip install -r ./requirements.txt

      - name: Set Pytest Marker
        id: set_marker
        run: |
          # В зависимости от выбора пользователя, определяем команду pytest
          if [ "${{ github.event.inputs.test_type }}" == "positive" ]; then
            echo "MARKER=positive" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.inputs.test_type }}" == "negative" ]; then
            echo "MARKER=negative" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.inputs.test_type }}" == "all" ]; then
            # Запуск всех тестов (без маркера)
            echo "MARKER=" >> $GITHUB_OUTPUT
          else
            # Если выбрано 'skip_tests' или любое другое значение
            echo "MARKER=skip_tests" >> $GITHUB_OUTPUT
          fi

      - name: Run Selected UI-tests
        env:
          VALID_LOGIN: ${{secrets.VALID_LOGIN}}
          VALID_PASSWORD: ${{secrets.VALID_PASSWORD}}
          BASE_URL: ${{secrets.BASE_URL}}
          EXPECTED_PROFILE_TITLE: ${{secrets.EXPECTED_PROFILE_TITLE}}
          EXPECTED_ERROR_MESSAGE: ${{secrets.EXPECTED_ERROR_MESSAGE}}
        run: |
          ALLURE_DIR="allure-results"
          mkdir -p $ALLURE_DIR
          
          if [ -z "${{ steps.set_marker.outputs.MARKER }}" ]; then
            echo "Запуск ВСЕХ тестов..."
            pytest --alluredir=$ALLURE_DIR
          else
            echo "Запуск тестов с маркером: ${{ steps.set_marker.outputs.MARKER }}..."
            pytest -m "${{ steps.set_marker.outputs.MARKER }}" --alluredir=$ALLURE_DIR
          fi

      - name: Generate Allure Report
        run: |
          echo "Installing Allure CLI"
          sudo apt-get install openjdk-17-jdk
          sudo wget -O /tmp/allure.zip https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.zip
          sudo unzip /tmp/allure.zip -d /opt/
          sudo ln -s /opt/allure-2.27.0/bin/allure /usr/bin/allure
          
          echo "Generating Allure Report..."
          allure generate allure-results --clean -o allure-report

      - name: Deploy Allure Report to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@4.1.5
        with:
          token: ${{secrets.GH_PAGES_TOKEN}}
          branch: gh-pages
          folder: allure-report
          clean: true